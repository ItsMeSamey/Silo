<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="author" content="CodeHim">
    <title>Slide Navbar Example</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="testing only/1main/styles.css">
    <link rel='stylesheet' href='https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css'>
    <link rel='stylesheet' href='https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css'>
    <script src='https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.2/dist/umd/popper.min.js'></script>
    <script src='https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.2.3/js/bootstrap.min.js'></script>
</head>
<body>
<script>
        function readFile() {
            const fileInput = document.getElementById('fileInput');
            const file = fileInput.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const fileStream = e.target.result;
                    // Now you have the file stream, you can do further processing
                    console.log("File Stream:", fileStream);
                };
                reader.readAsText(file);
            } else {
                console.error("No file selected.");
            }
        }

    let iv = null;
let useIV = true;
let Hmac = null;
function encrypt(fileStream, hashedPwd, useIV){
    if (useIV){
      let randomBytes   = CryptoJS.lib.WordArray.random(128/8).toString();
      //to generate random initialization vector value 
      iv = CryptoJS.enc.Hex.parse(randomBytes);
      console.log(`iv : ${iv}`);
      // old method (wrong) which used first 16 bytes of key (hashed pwd)
      // CryptoJS.enc.Hex.parse(key);
      //encryption of message using aes256
    message = CryptoJS.AES.encrypt(filestream, CryptoJS.enc.Hex.parse(hashedPwd),{iv: iv});
    console.log(`message.iv : ${message.iv}`);
    console.log(`message: ${message}`);
    console.log(`message.ciphertext ${message.ciphertext}`);
    console.log(`message.salt ${message.salt}`);
    }
  else{
    message = CryptoJS.AES.encrypt(filestream, hashedPwd );
  }
  
    return message.toString();
}

function decrypt(encryptedData, hashedPwd, useIV){
  let code;  
  if (useIV){
    console.log(`hashedPwd: ${hashedPwd}`);
    // we use original created iv
    // we now use the original _random_ iv which
    // is the correct way.  IV will be passed
    // in the clear to decrypting side
    // let iv = CryptoJS.enc.Hex.parse(key);
    console.log(`iv ${iv}`);
    code = CryptoJS.AES.decrypt(encryptedData, CryptoJS.enc.Hex.parse(hashedPwd),{iv:iv});
    console.log(`code ${code}`);
    //alert (typeof(code));
    console.log(code);
    }
  else{
    console.log("decrypting with no IV");
    code = CryptoJS.AES.decrypt(encryptedData, hashedPwd);
    console.log(code);
    
  }
  let decryptedMessage = "";
  if (code.sigBytes < 0){
    decryptedMessage = `Couldn't decrypt! It is probable that an incorrect password was used.`;
    return decryptedMessage;
  }
  decryptedMessage = code.toString(CryptoJS.enc.Utf8);
  return decryptedMessage;
}

function encryptFromText(){
  useIV = document.querySelector("#useIVCheckBox").checked;
  let cleartext_pwd = document.querySelector("#password").value
  let hashedPwd = sha256(cleartext_pwd);
document.querySelector("#cleartext_output").innerHTML = "";

 document.querySelector("#cipher_output").innerHTML =  encrypt(filestream,hashedPwd,useIV);
    generateHmac();
}

function decryptFromText(){
  document.querySelector("#cleartext_output").innerHTML = "";
  useIV = document.querySelector("#useIVCheckBox").checked;
  let cleartext_pwd = document.querySelector("#password").value;

  let hashedPwd = sha256(cleartext_pwd);
  console.log(`hashedPwd: ${hashedPwd}`);
  
  // either get the cipher text from the input box or the div
  let cipherText = document.querySelector("#cipher_text").value;
  if (cipherText == ""){
    cipherText = document.querySelector("#cipher_output").innerHTML;
  }
  console.log(cleartext_pwd);
  document.querySelector("#cleartext_output").innerHTML = decrypt(cipherText,hashedPwd,useIV);
}

function generateHmac(){
  let cleartext_pwd = document.querySelector("#password").value;
  let encryptedData = document.querySelector("#cipher_output")
  let macKey = sha256(cleartext_pwd);
  console.log(`key: ${macKey}`);
  let hash = sha256.hmac(`${iv}:${encryptedData}`, macKey.toString());
  Hmac = hash;
  console.log(`mac : ${Hmac}`);
  document.querySelector("#hmac").innerHTML = Hmac;
}

function validate(){
    let output = "The MAC is valid.";
    if (!validateMac()){
      output = "The MAC is NOT valid!";
    }
    document.querySelector("#validated").innerHTML = output;
  }

function validateMac(){
    // returns boolean (true if mac matches, otherwise false)
    let cleartext_pwd = document.querySelector("#password").value;
    let encryptedData = document.querySelector("#cipher_output")
    let key = sha256(cleartext_pwd);
    let mac = sha256.hmac(`${iv}:${encryptedData}`, key.toString());
    console.log(`mac : ${mac}`);
    return (mac == Hmac);
}

</script>
<script src="js/script.js"></script>
<script src="js/animtxt.js"></script>
<script src="/js/auth.js"></script>
<script src="/js/work.js"></script>
<script src="testing only/docs/script.js"></script>
    <script async defer src="https://apis.google.com/js/api.js" onload="gapiLoaded()"></script>
    <script async defer src="https://accounts.google.com/gsi/client" onload="gisLoaded()"></script>

    <!--Add buttons to initiate auth sequence and sign out-->
    
    <button onclick=downloadFile()>Download</button>

    <pre id="content" style="white-space: pre-wrap;"></pre>
    
<main class="cd__main">
    
    <header>
        <div class="d-flex flex-column flex-shrink-0 sidebar-wrap" style="z-index: 1000000;">
            <a href="/" class="text-decoration-none logo-wrap">
                <div class="icon-wrap"><i class="fab fa-slack"></i></div> <span>SILO</span>
            </a>
            <hr>
            <br>
            <ul class="nav nav-pills flex-column mb-auto">
                <li class="nav-item">
                    <a href="home.html" class="nav-link active" aria-current="page">
                        <div class="icon-wrap">
                            <i class="fas fa-home"></i>
                        </div>
                        <span> Home</span>
                    </a>
                </li>
                <li class="nav-item submenu">
                    <a href="#" class="nav-link">
                        <div class="icon-wrap">
                            <i class="fa fa-file"></i>
                        </div>
                        <span>Files</span>
                        <i class="fa fa-chevron-down submenu-arrow"></i>
                        <!-- Submenu content -->
                        <ul class="submenu-content">
                            <li><a href="photo.html">Photos</a></li>
                        </ul>
                    </a>
                </li>
                               
                <br>
                <li>
                    <!-- Add data-bs-toggle and data-bs-target to open modal -->
                  
                    <button class="nav-link" data-bs-toggle="modal" data-bs-target="#uploadModal" type="submit" class="btn-btn-primary-btn-lg" onclick=uploadFile()>
                        <div class="icon-wrap">
                            <i class="fa fa-plus-square"></i>
                        </div>
                        <span style="width: 100%;padding-right: 120px;">Upload</span>
                    </button>

                </li>
            </ul>
            <hr>
            <div class="dropdown">
                <a href="#" class="text-decoration-none dropdown-toggle  dropdown-wrap" id="dropdownUser2"
                   data-bs-toggle="dropdown" aria-expanded="false">
                    <div class="icon-wrap">
                        <img src="https://github.com/mdo.png" alt="" width="32" height="32" class="rounded-circle">
                    </div>
                    <strong>Customers</strong>
                </a>
                <ul class="dropdown-menu text-small shadow" aria-labelledby="dropdownUser2">
                    </li>
                    <li><button class="dropdown-item" id="signout_button" onclick="handleSignoutClick()">Sign Out</button></li>
                </ul>
            </div>
        </div>
    </header>
</main>

<!-- Modal for Upload -->

<div class="modal fade" id="uploadModal" tabindex="-1" aria-labelledby="uploadModalLabel" aria-hidden="true">
    
    <div class="modal-dialog modal-dialog-centered" id="uploadModal">
        <div class="modal-content">
            <div class="modal-header bg-yellow">
                <h5 class="modal-title text-black" id="uploadModalLabel">Upload Your Data</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" ></button>
            </div>
            <div class="modal-body">
                <!-- Add your upload form here -->
                <!-- Example: -->
                <form>
                    <div class="mb-3">
                      <br>
                        <input type="file" class="form-control" id="fileInput">
                    </div>
                    <button type="submit" class="btn-btn-primary-btn-lg" onclick=uploadFile()>Upload</button>
                </form>
            </div>
        </div>
    </div>
</div>
<div class="indmain">
    <div class="container">
        <div class="textsasda" style="right: 70px;top: 20px;position: fixed;color: white;"><h1>We Provide</h1></div>
        <h1 class="typing-text" style="font-size: 60px;right:50px;position: fixed;top: 70px;color: #ffa200;"></h1>
    <div class="cards">
        
        
        <div style="margin-left: 310px;" class="card">
            <img src="pexels-samer-daboul-1226721.jpg" alt="Card Image">
            <h1>Files</h1>
            <p>Enjoy your memories in the photos section!</p>
            <button onclick=encryptFromText()>
                <div class="icon-wrap">
                    <i class="fa fa-plus-square"></i>
                </div>
                <span>encrypt</span></button>
            </button>
                 <button class="nav-link" data-bs-toggle="modal" data-bs-target="#uploadModal" type="submit" class="btn-btn-primary-btn-lg" onclick=uploadFile()>
                        <div class="icon-wrap">
                            <i class="fa fa-plus-square"></i>
                        </div>
                        <span>Upload</span>
                    </button>
            
        </div>
        
  
  

</body>
</html>

